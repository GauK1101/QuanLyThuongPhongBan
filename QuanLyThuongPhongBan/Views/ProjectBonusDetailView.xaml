<UserControl
    x:Class="QuanLyThuongPhongBan.Views.ProjectBonusDetailView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:hc="https://handyorg.github.io/handycontrol"
    xmlns:viewModels="clr-namespace:QuanLyThuongPhongBan.ViewModels">

    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Styles/Styles.xaml" />
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </UserControl.Resources>

    <Border Background="#f8fafc">
        <!--  Main Content  -->
        <Grid Margin="5">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!--  Header và Action Buttons  -->
            <Border
                Grid.Row="0"
                Margin="0,0,0,10"
                Padding="15"
                Background="White"
                CornerRadius="8"
                Effect="{StaticResource ShadowEffect}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <!--  Title  -->
                    <TextBlock
                        Grid.Column="0"
                        VerticalAlignment="Center"
                        FontSize="18"
                        FontWeight="Bold"
                        Foreground="#2c3e50"
                        Text="QUẢN LÝ THƯỞNG DỰ ÁN CHI TIẾT" />

                    <!--  Search Box  -->
                    <StackPanel
                        Grid.Column="1"
                        HorizontalAlignment="Center"
                        Orientation="Horizontal">
                        <TextBlock
                            Margin="0,0,5,0"
                            VerticalAlignment="Center"
                            Text="Từ" />
                        <hc:DatePicker
                            Width="140"
                            hc:InfoElement.Placeholder="Ngày bắt đầu"
                            Language="vi-VN"
                            SelectedDate="{Binding FromDate, Mode=TwoWay}" />
                        <TextBlock
                            Margin="10,0,5,0"
                            VerticalAlignment="Center"
                            Text="Đến" />
                        <hc:DatePicker
                            Width="140"
                            hc:InfoElement.Placeholder="Ngày kết thúc"
                            Language="vi-VN"
                            SelectedDate="{Binding ToDate, Mode=TwoWay}" />
                        <Button
                            Width="50"
                            Height="32"
                            Margin="10,0,5,0"
                            Command="{Binding FilterCommand}"
                            Content="Lọc"
                            Style="{StaticResource ButtonPrimary}" />
                    </StackPanel>

                    <!--  Action Buttons  -->
                    <StackPanel
                        Grid.Column="2"
                        HorizontalAlignment="Right"
                        Orientation="Horizontal">
                        <Button
                            Width="120"
                            Height="32"
                            Margin="5,0,0,0"
                            Command="{Binding CreateReportCommand}"
                            Content="📄 Tạo báo cáo"
                            Style="{StaticResource ButtonInfo}" />
                        <Button
                            Width="100"
                            Height="32"
                            Margin="5,0,0,0"
                            Command="{Binding AddCommand}"
                            Content="➕ Thêm mới"
                            Style="{StaticResource ButtonSuccess}" />
                        <Button
                            Width="80"
                            Height="32"
                            Margin="5,0,0,0"
                            Command="{Binding DeleteCommand}"
                            Content="🗑️ Xóa"
                            Style="{StaticResource ButtonDanger}" />
                        <Button
                            Width="90"
                            Height="32"
                            Margin="5,0,0,0"
                            Command="{Binding RefreshCommand}"
                            Content="🔄 Làm mới"
                            Style="{StaticResource ButtonInfo}" />
                    </StackPanel>
                </Grid>
            </Border>

            <!--  DataGrid  -->
            <Border
                Grid.Row="1"
                Background="White"
                BorderThickness="1"
                CornerRadius="8"
                Effect="{StaticResource ShadowEffect}">
                <Grid>
                    <DataGrid
                        x:Name="ProjectBonusDetailGrid"
                        hc:DataGridAttach.CanUnselectAllWithBlankArea="True"
                        hc:DataGridAttach.ShowRowNumber="True"
                        AutoGenerateColumns="False"
                        CellEditEnding="DataGrid_CellEditEnding"
                        EnableColumnVirtualization="False"
                        GridLinesVisibility="Vertical"
                        HeadersVisibility="All"
                        ItemsSource="{Binding ProjectBonusDetails}"
                        PreviewKeyDown="ProjectBonusDetailGrid_PreviewKeyDown"
                        RowHeaderWidth="40"
                        SelectionChanged="DataGrid_SelectionChanged"
                        SelectionMode="Extended">

                        <DataGrid.ContextMenu>
                            <ContextMenu>
                                <!--  Menu Item Paste với Unicode Icon  -->
                                <MenuItem
                                    Command="{Binding PasteToSelectedRowCommand}"
                                    Header="Dán từ Excel"
                                    IsEnabled="{Binding CanPaste}"
                                    ToolTip="Dán dữ liệu từ clipboard Excel vào các dòng được chọn">
                                    <MenuItem.Icon>
                                        <TextBlock
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            FontSize="14"
                                            Text="📋" />
                                    </MenuItem.Icon>
                                </MenuItem>

                                <Separator />

                                <!--  Các menu item khác với Unicode icons  -->
                                <MenuItem
                                    Command="{Binding AddCommand}"
                                    Header="Thêm mới"
                                    ToolTip="Thêm dự án mới">
                                    <MenuItem.Icon>
                                        <TextBlock
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            FontSize="14"
                                            Text="➕" />
                                    </MenuItem.Icon>
                                </MenuItem>

                                <MenuItem
                                    Command="{Binding DeleteCommand}"
                                    Header="Xóa"
                                    ToolTip="Xóa các dòng được chọn">
                                    <MenuItem.Icon>
                                        <TextBlock
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            FontSize="14"
                                            Text="🗑️" />
                                    </MenuItem.Icon>
                                </MenuItem>

                                <Separator />

                                <MenuItem
                                    Command="{Binding RefreshCommand}"
                                    Header="Làm mới"
                                    ToolTip="Tải lại dữ liệu">
                                    <MenuItem.Icon>
                                        <TextBlock
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            FontSize="14"
                                            Text="🔄" />
                                    </MenuItem.Icon>
                                </MenuItem>

                                <MenuItem
                                    Command="{Binding CreateReportCommand}"
                                    Header="Tạo báo cáo"
                                    ToolTip="Tạo báo cáo từ các dòng được chọn">
                                    <MenuItem.Icon>
                                        <TextBlock
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            FontSize="14"
                                            Text="📊" />
                                    </MenuItem.Icon>
                                </MenuItem>
                            </ContextMenu>
                        </DataGrid.ContextMenu>

                        <DataGrid.RowHeaderTemplate>
                            <DataTemplate>
                                <CheckBox IsChecked="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=DataGridRow}}" />
                            </DataTemplate>
                        </DataGrid.RowHeaderTemplate>

                        <DataGrid.Columns>

                            <!--  ID Column  -->
                            <DataGridTextColumn
                                Width="60"
                                Binding="{Binding Id}"
                                Header="🆔 ID"
                                IsReadOnly="True">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="ToolTip" Value="{Binding Id}" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <!--  Project Information  -->
                            <DataGridTextColumn
                                Width="200"
                                Binding="{Binding ProjectName}"
                                Header="📁 Dự án">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="ToolTip" Value="{Binding ProjectName}" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <DataGridTextColumn
                                Width="180"
                                Binding="{Binding Investor}"
                                Header="👤 Chủ đầu tư">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="ToolTip" Value="{Binding Investor}" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <DataGridTextColumn
                                Width="120"
                                Binding="{Binding ContractNumber}"
                                Header="📄 Hợp đồng số">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="ToolTip" Value="{Binding ContractNumber}" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <!--  Date Column  -->
                            <DataGridTextColumn Binding="{Binding Date, StringFormat=dd/MM/yyyy}" Header="📅 Ngày tháng">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="ToolTip" Value="{Binding Date, StringFormat='Ngày: {0:dd/MM/yyyy}'}" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <!--  Revenue Columns  -->
                            <DataGridTextColumn Binding="{Binding ContractRevenue, StringFormat=N0}" Header="💰 Doanh thu HĐ">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="ToolTip" Value="{Binding ContractRevenue, StringFormat='Doanh thu hợp đồng: {0:N0} VNĐ'}" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <DataGridTextColumn Binding="{Binding SettlementRevenue, StringFormat=N0}" Header="📊 Doanh thu QT">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="ToolTip" Value="{Binding SettlementRevenue, StringFormat='Doanh thu quyết toán: {0:N0} VNĐ'}" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <DataGridTextColumn Binding="{Binding InvoicedRevenue, StringFormat=N0}" Header="🧾 Đã xuất HĐ">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="ToolTip" Value="{Binding InvoicedRevenue, StringFormat='Doanh thu đã xuất HĐ: {0:N0} VNĐ'}" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <DataGridTextColumn Binding="{Binding UninvoicedRevenue, StringFormat=N0}" Header="⏳ Chưa xuất HĐ">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="ToolTip" Value="{Binding UninvoicedRevenue, StringFormat='Doanh thu chưa xuất HĐ: {0:N0} VNĐ'}" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <!--  Payment Columns  -->
                            <DataGridTextColumn Binding="{Binding PaidAmount, StringFormat=N0}" Header="✔ Đã thanh toán">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="ToolTip" Value="{Binding PaidAmount, StringFormat='Đã thanh toán: {0:N0} VNĐ'}" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <DataGridTextColumn Binding="{Binding UnpaidAmount, StringFormat=N0}" Header="❗ Chưa thanh toán">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="ToolTip" Value="{Binding UnpaidAmount, StringFormat='Chưa thanh toán: {0:N0} VNĐ'}" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <!--  Coefficient Columns  -->
                            <DataGridTextColumn Binding="{Binding TVGP, StringFormat=N0}" Header="📐 TVGP">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="ToolTip" Value="{Binding TVGP, StringFormat='Tư vấn giám sát: {0:N0}'}" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <DataGridTextColumn Binding="{Binding HSDA, StringFormat=N0}" Header="📐 HSDA">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="ToolTip" Value="{Binding HSDA, StringFormat='Hệ số dự án: {0:N0}'}" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <DataGridTextColumn Binding="{Binding KTK, StringFormat=N0}" Header="📐 KTK">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="ToolTip" Value="{Binding KTK, StringFormat='Kỹ thuật - thiết kế: {0:N0}'}" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <DataGridTextColumn Binding="{Binding PO, StringFormat=N0}" Header="📐 PO">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="ToolTip" Value="{Binding PO, StringFormat='Purchase Order: {0:N0}'}" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <DataGridTextColumn Binding="{Binding TTDVKT, StringFormat=N0}" Header="📐 TTDVKT">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="ToolTip" Value="{Binding TTDVKT, StringFormat='Tư vấn dịch vụ kỹ thuật: {0:N0}'}" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <!--  Notes  -->
                            <DataGridTextColumn
                                Width="200"
                                Binding="{Binding Notes}"
                                Header="📝 Ghi chú">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="ToolTip" Value="{Binding Notes}" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                        </DataGrid.Columns>

                    </DataGrid>

                    <hc:LoadingCircle Visibility="{Binding IsLoading}" />

                </Grid>
            </Border>

            <Border
                Grid.Row="2"
                Margin="0,10,0,0"
                Padding="5"
                Background="White"
                CornerRadius="8"
                Effect="{StaticResource ShadowEffect}">
                <Grid Grid.Row="2">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition />
                        <ColumnDefinition />
                    </Grid.ColumnDefinitions>


                    <TextBlock
                        Grid.Column="0"
                        Grid.ColumnSpan="3"
                        Margin="15,0,0,0"
                        HorizontalAlignment="Left"
                        VerticalAlignment="Center"
                        FontSize="14"
                        FontWeight="SemiBold"
                        Foreground="{Binding RowCountColor}"
                        Text="{Binding RowCountText}" />

                    <StackPanel
                        Grid.Column="1"
                        HorizontalAlignment="Right"
                        Orientation="Horizontal">
                        <Border
                            Padding="5"
                            Background="#f8f9fa"
                            BorderBrush="#e0e0e0"
                            BorderThickness="1"
                            CornerRadius="8">

                            <hc:Pagination
                                IsJumpEnabled="True"
                                MaxPageCount="{Binding MaxPageCount}"
                                PageIndex="{Binding PageIndex}">
                                <hc:Interaction.Triggers>
                                    <hc:EventTrigger EventName="PageUpdated">
                                        <hc:EventToCommand Command="{Binding PageOnCommand}" PassEventArgsToCommand="True" />
                                    </hc:EventTrigger>
                                </hc:Interaction.Triggers>
                            </hc:Pagination>

                        </Border>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>

        <!--  Loading Indicator  -->
    </Border>
</UserControl>