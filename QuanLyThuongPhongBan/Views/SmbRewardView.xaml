<UserControl
    x:Class="QuanLyThuongPhongBan.Views.SmbRewardView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:hc="https://handyorg.github.io/handycontrol"
    xmlns:local="clr-namespace:QuanLyThuongPhongBan.Views"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">

    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Styles/Styles.xaml" />
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </UserControl.Resources>

    <Border Background="#f8fafc">
        <!--  Main Content  -->
        <Grid Margin="5">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!--  Header và Action Buttons  -->
            <Border
                Grid.Row="0"
                Margin="0,0,0,10"
                Padding="15"
                Background="White"
                CornerRadius="8"
                Effect="{StaticResource ShadowEffect}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <!--  Title  -->
                    <TextBlock
                        Grid.Column="0"
                        VerticalAlignment="Center"
                        FontSize="18"
                        FontWeight="Bold"
                        Foreground="#2c3e50"
                        Text="QUẢN LÝ THƯỞNG SMB" />

                    <!--  Search Box  -->
                    <StackPanel Grid.Column="1" HorizontalAlignment="Center">
                        <hc:SearchBar
                            Width="300px"
                            Height="32"
                            hc:InfoElement.Necessary="True"
                            hc:InfoElement.Placeholder="Tìm kiếm"
                            Command="{Binding SearchCommand}"
                            Style="{StaticResource SearchBarExtend}"
                            Text="{Binding SearchKeyword, UpdateSourceTrigger=PropertyChanged}" />
                    </StackPanel>

                    <!--  Action Buttons  -->
                    <StackPanel
                        Grid.Column="2"
                        HorizontalAlignment="Right"
                        Orientation="Horizontal">
                        <Button
                            Width="100"
                            Height="32"
                            Margin="5,0,0,0"
                            Command="{Binding AddCommand}"
                            Content="➕ Thêm mới"
                            Style="{StaticResource ButtonSuccess}" />
                        <Button
                            Width="80"
                            Height="32"
                            Margin="5,0,0,0"
                            Command="{Binding DeleteCommand}"
                            Content="🗑️ Xóa"
                            Style="{StaticResource ButtonDanger}" />
                        <Button
                            Width="90"
                            Height="32"
                            Margin="5,0,0,0"
                            Command="{Binding RefreshCommand}"
                            Content="🔄 Làm mới"
                            Style="{StaticResource ButtonInfo}" />
                    </StackPanel>
                </Grid>
            </Border>

            <!--  DataGrid  -->
            <Border
                Grid.Row="1"
                Background="White"
                BorderThickness="1"
                CornerRadius="8"
                Effect="{StaticResource ShadowEffect}">
                <Grid>
                    <DataGrid
                        x:Name="myDataGrid"
                        hc:DataGridAttach.CanUnselectAllWithBlankArea="True"
                        hc:DataGridAttach.ShowRowNumber="True"
                        AutoGenerateColumns="False"
                        CellEditEnding="AnyCellEditEnding"
                        EnableColumnVirtualization="False"
                        GridLinesVisibility="Vertical"
                        HeadersVisibility="All"
                        ItemsSource="{Binding SmbBonus}"
                        RowHeaderWidth="40"
                        SelectionChanged="DataGrid_SelectionChanged"
                        SelectionMode="Extended"
                        VirtualizingStackPanel.IsVirtualizing="True"
                        VirtualizingStackPanel.VirtualizationMode="Recycling">

                        <DataGrid.ContextMenu>
                            <ContextMenu>
                                <!--  Menu Item Paste với Unicode Icon  -->
                                <MenuItem
                                    Command="{Binding PasteToSelectedRowCommand}"
                                    Header="Dán từ Excel"
                                    IsEnabled="{Binding CanPaste}"
                                    ToolTip="Dán dữ liệu từ clipboard Excel vào các dòng được chọn">
                                    <MenuItem.Icon>
                                        <TextBlock
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            FontSize="14"
                                            Text="📋" />
                                    </MenuItem.Icon>
                                </MenuItem>

                                <Separator />

                                <!--  Các menu item khác với Unicode icons  -->
                                <MenuItem
                                    Command="{Binding AddCommand}"
                                    Header="Thêm mới"
                                    ToolTip="Thêm dự án mới">
                                    <MenuItem.Icon>
                                        <TextBlock
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            FontSize="14"
                                            Text="➕" />
                                    </MenuItem.Icon>
                                </MenuItem>

                                <MenuItem
                                    Command="{Binding DeleteCommand}"
                                    Header="Xóa"
                                    ToolTip="Xóa các dòng được chọn">
                                    <MenuItem.Icon>
                                        <TextBlock
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            FontSize="14"
                                            Text="🗑️" />
                                    </MenuItem.Icon>
                                </MenuItem>

                                <Separator />

                                <MenuItem
                                    Command="{Binding RefreshCommand}"
                                    Header="Làm mới"
                                    ToolTip="Tải lại dữ liệu">
                                    <MenuItem.Icon>
                                        <TextBlock
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            FontSize="14"
                                            Text="🔄" />
                                    </MenuItem.Icon>
                                </MenuItem>

                                <MenuItem
                                    Command="{Binding CreateReportCommand}"
                                    Header="Tạo báo cáo"
                                    ToolTip="Tạo báo cáo từ các dòng được chọn">
                                    <MenuItem.Icon>
                                        <TextBlock
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            FontSize="14"
                                            Text="📊" />
                                    </MenuItem.Icon>
                                </MenuItem>
                            </ContextMenu>
                        </DataGrid.ContextMenu>

                        <DataGrid.RowHeaderTemplate>
                            <DataTemplate>
                                <CheckBox IsChecked="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=DataGridRow}}" />
                            </DataTemplate>
                        </DataGrid.RowHeaderTemplate>

                        <DataGrid.Columns>
                            <!--  ID Column  -->
                            <DataGridTextColumn
                                Width="60"
                                Binding="{Binding Id}"
                                Header="🆔 ID"
                                IsReadOnly="True">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="ToolTip" Value="{Binding Id}" />
                                        <Setter Property="HorizontalAlignment" Value="Center" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <!--  Quarter Year  -->
                            <DataGridTextColumn
                                Width="120"
                                Binding="{Binding QuarterYear}"
                                Header="📅 Quý năm thưởng">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="ToolTip" Value="{Binding QuarterYear}" />
                                        <Setter Property="HorizontalAlignment" Value="Center" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <!--  Total SMB Value  -->
                            <DataGridTextColumn
                                Width="140"
                                Binding="{Binding TotalSmbValue, StringFormat=N0}"
                                Header="💰 Tổng giá trị SMB">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="ToolTip" Value="{Binding TotalSmbValue, StringFormat='Tổng giá trị SMB: {0:N0} VNĐ'}" />
                                        <Setter Property="HorizontalAlignment" Value="Right" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <!--  Invoice Output  -->
                            <DataGridTextColumn
                                Width="140"
                                Binding="{Binding InvoiceOutput, StringFormat=N0}"
                                Header="🧾 Xuất hóa đơn">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="ToolTip" Value="{Binding InvoiceOutput, StringFormat='Xuất hóa đơn: {0:N0} VNĐ'}" />
                                        <Setter Property="HorizontalAlignment" Value="Right" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <!--  Total SMB Bonus Rate  -->
                            <DataGridTextColumn
                                Width="110"
                                Binding="{Binding TotalSmbBonusRate, StringFormat={}{0:0.#####}%}"
                                Header="📊 Tỉ lệ thưởng">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="ToolTip" Value="{Binding TotalSmbBonusRate, StringFormat='Tổng tỉ lệ thưởng SMB: {0:0.#####}%'}" />
                                        <Setter Property="HorizontalAlignment" Value="Center" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <!--  Total SMB Bonus Value  -->
                            <DataGridTextColumn
                                Width="140"
                                Binding="{Binding TotalSmbBonusValue, StringFormat=N0}"
                                Header="💵 Tổng giá trị thưởng">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="ToolTip" Value="{Binding TotalSmbBonusValue, StringFormat='Tổng giá trị thưởng SMB: {0:N0} VNĐ'}" />
                                        <Setter Property="HorizontalAlignment" Value="Right" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <!--  Total Phase 1 Rate  -->
                            <DataGridTextColumn
                                Width="120"
                                Binding="{Binding TotalPhase1Rate, StringFormat={}{0:0.#####}%}"
                                Header="📈 Tỉ lệ đợt 1">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="ToolTip" Value="{Binding TotalPhase1Rate, StringFormat='Tổng tỉ lệ đợt 1: {0:0.#####}%'}" />
                                        <Setter Property="HorizontalAlignment" Value="Center" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <!--  Total Phase 1 Value  -->
                            <DataGridTextColumn
                                Width="140"
                                Binding="{Binding TotalPhase1Value, StringFormat=N0}"
                                Header="💹 Giá trị đợt 1">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="ToolTip" Value="{Binding TotalPhase1Value, StringFormat='Tổng giá trị đợt 1: {0:N0} VNĐ'}" />
                                        <Setter Property="HorizontalAlignment" Value="Right" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <!--  Total Debt Recovery  -->
                            <DataGridTextColumn
                                Width="140"
                                Binding="{Binding TotalDebtRecovery, StringFormat=N0}"
                                Header="🔄 Thu hồi công nợ">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="ToolTip" Value="{Binding TotalDebtRecovery, StringFormat='Tổng thu hồi công nợ: {0:N0} VNĐ'}" />
                                        <Setter Property="HorizontalAlignment" Value="Right" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <!--  Total Acceptance  -->
                            <DataGridTextColumn
                                Width="140"
                                Binding="{Binding TotalAcceptance, StringFormat=N0}"
                                Header="✅ Tổng nghiệm thu">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="ToolTip" Value="{Binding TotalAcceptance, StringFormat='Tổng giá trị nghiệm thu: {0:N0} VNĐ'}" />
                                        <Setter Property="HorizontalAlignment" Value="Right" />
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                        </DataGrid.Columns>

                        <!--  Row Details Template  -->
                        <DataGrid.RowDetailsTemplate>
                            <DataTemplate>
                                <Border
                                    Margin="20,5,5,5"
                                    Padding="10"
                                    Background="#f1f5f9"
                                    CornerRadius="6">
                                    <StackPanel>
                                        <DataGrid
                                            Margin="-50,0,0,0"
                                            hc:DataGridAttach.CanUnselectAllWithBlankArea="True"
                                            hc:DataGridAttach.ShowRowNumber="True"
                                            AutoGenerateColumns="False"
                                            CanUserAddRows="False"
                                            CanUserSortColumns="True"
                                            CellEditEnding="AnyCellEditEnding"
                                            FontSize="11.5"
                                            GridLinesVisibility="Vertical"
                                            HeadersVisibility="Column"
                                            ItemsSource="{Binding SmbTeamBonuses}"
                                            SelectedItem="{Binding SelectedSmbTeamBonus}">
                                            <DataGrid.Columns>
                                                <!--  Department  -->
                                                <DataGridTextColumn
                                                    Width="150"
                                                    Binding="{Binding Department.Name}"
                                                    Header="🏢 Phòng ban"
                                                    IsReadOnly="True">
                                                    <DataGridTextColumn.ElementStyle>
                                                        <Style TargetType="TextBlock">
                                                            <Setter Property="ToolTip" Value="{Binding Department.Name}" />
                                                        </Style>
                                                    </DataGridTextColumn.ElementStyle>
                                                </DataGridTextColumn>

                                                <!--  Contract Revenue  -->
                                                <DataGridTextColumn
                                                    Width="140"
                                                    Binding="{Binding ContractRevenue, StringFormat=N0}"
                                                    Header="📑 Doanh thu hợp đồng">
                                                    <DataGridTextColumn.ElementStyle>
                                                        <Style TargetType="TextBlock">
                                                            <Setter Property="ToolTip" Value="{Binding ContractRevenue, StringFormat='Doanh thu hợp đồng: {0:N0} VNĐ'}" />
                                                            <Setter Property="HorizontalAlignment" Value="Right" />
                                                        </Style>
                                                    </DataGridTextColumn.ElementStyle>
                                                </DataGridTextColumn>

                                                <!--  Invoice Revenue  -->
                                                <DataGridTextColumn
                                                    Width="140"
                                                    Binding="{Binding InvoiceRevenue, StringFormat=N0}"
                                                    Header="🧾 Doanh thu xuất HĐ">
                                                    <DataGridTextColumn.ElementStyle>
                                                        <Style TargetType="TextBlock">
                                                            <Setter Property="ToolTip" Value="{Binding InvoiceRevenue, StringFormat='Doanh thu xuất hóa đơn: {0:N0} VNĐ'}" />
                                                            <Setter Property="HorizontalAlignment" Value="Right" />
                                                        </Style>
                                                    </DataGridTextColumn.ElementStyle>
                                                </DataGridTextColumn>

                                                <!--  Total Smb Rate  -->
                                                <DataGridTextColumn
                                                    Width="120"
                                                    Binding="{Binding TotalSmbRate, StringFormat={}{0:0.######}%}"
                                                    Header="📊 Tỉ lệ tổng SMB">
                                                    <DataGridTextColumn.ElementStyle>
                                                        <Style TargetType="TextBlock">
                                                            <Setter Property="ToolTip" Value="{Binding TotalSmbRate, StringFormat='Tỉ lệ tổng SMB: {0:0.######}%'}" />
                                                            <Setter Property="HorizontalAlignment" Value="Center" />
                                                        </Style>
                                                    </DataGridTextColumn.ElementStyle>
                                                </DataGridTextColumn>

                                                <!--  Total Smb Value  -->
                                                <DataGridTextColumn
                                                    Width="140"
                                                    Binding="{Binding TotalSmbValue, StringFormat=N0}"
                                                    Header="💎 Giá trị tổng SMB">
                                                    <DataGridTextColumn.ElementStyle>
                                                        <Style TargetType="TextBlock">
                                                            <Setter Property="ToolTip" Value="{Binding TotalSmbValue, StringFormat='Giá trị tổng SMB: {0:N0} VNĐ'}" />
                                                            <Setter Property="HorizontalAlignment" Value="Right" />
                                                        </Style>
                                                    </DataGridTextColumn.ElementStyle>
                                                </DataGridTextColumn>

                                                <!--  Phase 1 Rate  -->
                                                <DataGridTextColumn
                                                    Width="120"
                                                    Binding="{Binding Phase1Rate, StringFormat={}{0:0.######}%}"
                                                    Header="📈 Tỉ lệ đợt 1">
                                                    <DataGridTextColumn.ElementStyle>
                                                        <Style TargetType="TextBlock">
                                                            <Setter Property="ToolTip" Value="{Binding Phase1Rate, StringFormat='Tỉ lệ đợt 1: {0:0.######}%'}" />
                                                            <Setter Property="HorizontalAlignment" Value="Center" />
                                                        </Style>
                                                    </DataGridTextColumn.ElementStyle>
                                                </DataGridTextColumn>

                                                <!--  Phase 1 Value  -->
                                                <DataGridTextColumn
                                                    Width="140"
                                                    Binding="{Binding Phase1Value, StringFormat=N0}"
                                                    Header="💰 Giá trị đợt 1">
                                                    <DataGridTextColumn.ElementStyle>
                                                        <Style TargetType="TextBlock">
                                                            <Setter Property="ToolTip" Value="{Binding Phase1Value, StringFormat='Giá trị đợt 1: {0:N0} VNĐ'}" />
                                                            <Setter Property="HorizontalAlignment" Value="Right" />
                                                        </Style>
                                                    </DataGridTextColumn.ElementStyle>
                                                </DataGridTextColumn>

                                                <!--  Debt Recovery Rate  -->
                                                <DataGridTextColumn
                                                    Width="140"
                                                    Binding="{Binding DebtRecoveryRate, StringFormat={}{0:0.#####}%}"
                                                    Header="📉 Tỉ lệ thu hồi nợ">
                                                    <DataGridTextColumn.ElementStyle>
                                                        <Style TargetType="TextBlock">
                                                            <Setter Property="ToolTip" Value="{Binding DebtRecoveryRate, StringFormat='Tỉ lệ thu hồi công nợ: {0:0.#####}%'}" />
                                                            <Setter Property="HorizontalAlignment" Value="Center" />
                                                        </Style>
                                                    </DataGridTextColumn.ElementStyle>
                                                </DataGridTextColumn>

                                                <!--  Debt Recovery  -->
                                                <DataGridTextColumn
                                                    Width="140"
                                                    Binding="{Binding DebtRecovery, StringFormat=N0}"
                                                    Header="💳 Thu hồi công nợ">
                                                    <DataGridTextColumn.ElementStyle>
                                                        <Style TargetType="TextBlock">
                                                            <Setter Property="ToolTip" Value="{Binding DebtRecovery, StringFormat='Thu hồi công nợ: {0:N0} VNĐ'}" />
                                                            <Setter Property="HorizontalAlignment" Value="Right" />
                                                        </Style>
                                                    </DataGridTextColumn.ElementStyle>
                                                </DataGridTextColumn>

                                                <!--  Acceptance  -->
                                                <DataGridTextColumn
                                                    Width="140"
                                                    Binding="{Binding Acceptance, StringFormat=N0}"
                                                    Header="✅ Nghiệm thu">
                                                    <DataGridTextColumn.ElementStyle>
                                                        <Style TargetType="TextBlock">
                                                            <Setter Property="ToolTip" Value="{Binding Acceptance, StringFormat='Nghiệm thu: {0:N0} VNĐ'}" />
                                                            <Setter Property="HorizontalAlignment" Value="Right" />
                                                        </Style>
                                                    </DataGridTextColumn.ElementStyle>
                                                </DataGridTextColumn>

                                            </DataGrid.Columns>
                                        </DataGrid>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </DataGrid.RowDetailsTemplate>
                    </DataGrid>

                    <hc:LoadingCircle Visibility="{Binding IsLoading}" />

                </Grid>
            </Border>

            <Border
                Grid.Row="2"
                Margin="0,10,0,0"
                Padding="5"
                Background="White"
                CornerRadius="8"
                Effect="{StaticResource ShadowEffect}">
                <Grid Grid.Row="2">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition />
                        <ColumnDefinition />
                    </Grid.ColumnDefinitions>


                    <TextBlock
                        Grid.Column="0"
                        Grid.ColumnSpan="3"
                        Margin="15,0,0,0"
                        HorizontalAlignment="Left"
                        VerticalAlignment="Center"
                        FontSize="14"
                        FontWeight="SemiBold"
                        Foreground="{Binding RowCountColor}"
                        Text="{Binding RowCountText}" />

                    <StackPanel
                        Grid.Column="1"
                        HorizontalAlignment="Right"
                        Orientation="Horizontal">
                        <Border
                            Padding="5"
                            Background="#f8f9fa"
                            BorderBrush="#e0e0e0"
                            BorderThickness="1"
                            CornerRadius="8">

                            <hc:Pagination
                                IsJumpEnabled="True"
                                MaxPageCount="{Binding MaxPageCount}"
                                PageIndex="{Binding PageIndex}">
                                <hc:Interaction.Triggers>
                                    <hc:EventTrigger EventName="PageUpdated">
                                        <hc:EventToCommand Command="{Binding PageOnCommand}" PassEventArgsToCommand="True" />
                                    </hc:EventTrigger>
                                </hc:Interaction.Triggers>
                            </hc:Pagination>

                        </Border>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>
    </Border>
</UserControl>
